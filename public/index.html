<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT UNS Viewer</title>
    <meta name="description" content="Explore your MQTT data in real-time. A lightweight web viewer for Unified Namespace (UNS), IIoT, and Sparkplug B.">
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/view.tree.css">
    <link rel="stylesheet" href="css/view.svg.css">
    <link rel="stylesheet" href="css/view.history.css">
    <link rel="stylesheet" href="css/view.mapper.css">
    <link rel="stylesheet" href="css/view.chart.css">
    <link rel="stylesheet" href="css/view.publish.css"> 
    <link rel="stylesheet" href="css/view.chat.css"> 
    <link rel="stylesheet" href="css/view.alerts.css"> 
    <script src="libs/chart-min.js"></script>
    <script src="libs/chartjs-adapter-date-fns-min.js"></script>
    <script src="libs/hammer.min.js"></script>
    <script src="libs/chartjs-plugin-zoom.min.js"></script>
    <script src="libs/ace-min.js"></script>
    <script src="libs/marked.min.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>MQTT UNS Viewer</h1>
            <div class="header-sub-row">
                <p>v 1.5.0-beta57</p>
                <div id="broker-status-container" class="broker-status-container"></div>
            </div>
        </div>
        <div id="current-datetime" class="datetime-container"></div>
        <a href="config.html" id="btn-config-view" class="nav-button icon-button" title="Configuration">&#9881;</a>
        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="dark-mode-toggle">
                <input type="checkbox" id="dark-mode-toggle" />
                <span class="slider round"></span>
            </label>
            <span class="theme-label">Dark Mode</span>
        </div>
    </header>
    <nav class="tab-nav">
        <button id="btn-tree-view" class="tab-button active">Tree View</button>
        <button id="btn-map-view" class="tab-button">SVG View</button>
        <button id="btn-history-view" class="tab-button">History</button>
        <button id="btn-mapper-view" class="tab-button">Mapper</button>
        <button id="btn-chart-view" class="tab-button">Chart</button>
        <button id="btn-alerts-view" class="tab-button">Alerts</button>
        <button id="btn-publish-view" class="tab-button">Publish</button> 
        <button id="btn-admin-view" class="tab-button" style="display: none; border-bottom-color: var(--color-danger);">Admin</button>
    </nav>
    <div class="view-container">
        <main id="tree-view" class="view active">
            <div class="tree-view-wrapper">
                <div class="tree-controls" style="align-items: center;">
                    <input type="text" id="tree-filter-input" placeholder="Filter topics...">
                    <button id="btn-expand-all" class="tool-button" title="Expand All">‚ñ≤</button>
                    <button id="btn-collapse-all" class="tool-button" title="Collapse All">‚ñº</button>
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 4px; font-size: 0.85em; color: var(--color-text-secondary); white-space: nowrap; margin-left: 2px;" title="Disable data traversal animations">
                        <input type="checkbox" id="disable-tree-animations" style="margin: 0; padding: 0;"> Disable Anim.
                    </label>
                </div>
                <div id="mqtt-tree" class="tree-container"></div>
            </div>
            <div class="resizer" id="drag-handle-vertical"></div>
            <div id="payload-display" class="payload-container">
                <div id="payload-main-area">
                    <div class="payload-header">
                        <h2>Payload</h2>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <button id="btn-create-alert-from-tree" class="tool-button" style="display:none; font-size:0.8em;">üîî Create Alert Rule</button>
                            <div class="payload-controls">
                                <input type="checkbox" id="live-payload-toggle" name="live-payload-toggle" checked>
                                <label for="live-payload-toggle">Live Update</label>
                            </div>
                        </div>
                    </div>
                    <div id="payload-topic" class="payload-topic-display">No topic selected</div>
                    <pre id="payload-content">Select a topic to see its payload.</pre>
                </div>
                <div class="resizer-horizontal" id="drag-handle-horizontal"></div>
                <div id="topic-history-container" class="topic-history-container">
                    <h3 class="topic-history-header">Recent History</h3>
                    <div id="topic-history-log" class="topic-history-log">
                        <p class="history-placeholder">Select a topic to see its recent history.</p>
                    </div>
                </div>
            </div>
        </main>
        
        <main id="map-view" class="view">
            <div class="map-view-container">
                <div class="map-view-controls">
                    <div class="form-group" style="margin: 0;">
                        <label for="svg-select-dropdown" style="font-size: 0.9em; margin-bottom: 2px;">Select View:</label>
                        <select id="svg-select-dropdown" style="padding: 4px 8px; font-size: 0.9em; border-radius: 4px; border: 1px solid var(--color-border); background-color: var(--color-bg-tertiary); color: var(--color-text);">
                        </select>
                    </div>
                    <div class="history-toggle-container">
                        <input type="checkbox" id="svg-history-toggle" name="svg-history-toggle">
                        <label for="svg-history-toggle">History Mode</label>
                    </div>
                    <div id="svg-timeline-slider-container" class="time-slider-container">
                        <div class="slider-track"></div>
                        <div class="slider-handle" id="svg-handle">
                            <div class="slider-label" id="svg-label"></div>
                        </div>
                    </div>
                    <button id="btn-svg-fullscreen" class="tool-button" title="Toggle Fullscreen">&#x2922;</button>
                </div>
                <div id="svg-content" class="svg-content"></div>
            </div>
        </main>

        <main id="history-view" class="view">
            <div class="history-status-bar">
                <div>Total Messages: <span id="history-total-messages">--</span></div>
                <div>DB Size: <span id="history-db-size">--</span> / <span id="history-db-limit">--</span> MB</div>
            </div>
            <div class="history-controls">
                <input type="text" id="history-search-input" placeholder="Filter by keyword in topic or payload...">
                <div id="time-range-slider-container" class="time-slider-container">
                    <div class="slider-track"></div>
                    <div class="slider-range" id="slider-range"></div>
                    <div class="slider-handle" id="handle-min">
                        <div class="slider-label" id="label-min"></div>
                    </div>
                    <div class="slider-handle" id="handle-max">
                        <div class="slider-label" id="label-max"></div>
                    </div>
                </div>
            </div>
            <div id="historical-log-container" class="historical-log-container">
            </div>
            <div id="pruning-indicator" class="pruning-indicator">
                <p>Cleaning database, please wait...</p>
            </div>
        </main>

        <main id="mapper-view" class="view">
            <div class="mapper-tree-wrapper">
                <div class="tree-controls">
                    <input type="text" id="mapper-filter-input" placeholder="Filter topics...">
                    <button id="btn-mapper-expand-all" class="tool-button" title="Expand All">‚ñ≤</button>
                    <button id="btn-mapper-collapse-all" class="tool-button" title="Collapse All">‚ñº</button>
                </div>
                <div id="mapper-tree" class="tree-container">
                </div>
            </div>
            <div class="resizer" id="drag-handle-vertical-mapper"></div>
            <div id="mapper-payload-container" class="payload-container">
                <div id="mapper-payload-area" class="payload-main-area">
                    <div class="payload-header">
                        <h2>Payload (Source)</h2>
                    </div>
                    <div id="mapper-payload-topic" class="payload-topic-display">Select a topic from the Mapper tree.
                    </div>
                    <pre id="mapper-payload-content"></pre>
                </div>
                <div class="resizer-horizontal" id="drag-handle-horizontal-mapper"></div>
                <div id="mapper-transform-area" class="topic-history-container">
                    <div class="mapper-controls">
                        <div class="form-group">
                            <label for="mapper-version-select">Active Version:</label>
                            <select id="mapper-version-select"></select>
                        </div>
                        <button id="mapper-save-button" class="tool-button button-primary">Save</button>
                        <button id="mapper-save-as-new-button" class="tool-button">Save as New...</button>
                        <span id="mapper-save-status"></span>
                    </div>
                    <div id="mapper-transform-placeholder" class="history-placeholder">
                        <p>Select a topic in the Mapper tree to create or edit its transformation rules.</p>
                    </div>
                    <form id="mapper-transform-form" style="display: none;">
                        <div class="mapper-transform-header">
                            <div class="form-group">
                                <label for="mapper-source-topic">Source Topic (Pattern):</label>
                                <input type="text" id="mapper-source-topic" readonly>
                            </div>
                            <button type="button" id="mapper-add-target-button" class="tool-button">Add Target</button>
                        </div>
                        <div id="mapper-targets-list">
                        </div>
                        <div id="mapper-targets-placeholder" class="history-placeholder" style="display: none;">
                            <p>No targets defined for this rule. Click "Add Target" to create one.</p>
                        </div>

                        <template id="mapper-target-template">
                            <div class="mapper-target-editor collapsed">
                                <div class="target-editor-header">
                                    <div style="display:flex; align-items:center; gap:10px; flex-grow:1;">
                                        <button type="button" class="target-toggle-collapse" title="Toggle Details">‚ñ∂</button>
                                        <input type="text" class="target-editor-title-input" title="Target Name" placeholder="Target Name">
                                    </div>
                                    <div class="target-editor-controls">
                                        <button type="button" class="target-save-maximized tool-button button-primary" style="display:none; margin-right:15px;">üíæ Save Live</button>
                                        <button type="button" class="target-minimize-button tool-button" style="display:none; margin-right:15px;">‚úñ Minimize</button>
                                        <input type="checkbox" class="target-enabled-toggle">
                                        <label class="checkbox-label" style="margin-right: 15px;">Enabled</label>
                                        <button type="button" class="target-delete-button tool-button button-danger">Delete</button>
                                    </div>
                                </div>
                                <div class="target-editor-body">
                                    <div class="target-settings-row" style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px dashed var(--color-border-secondary);">
                                        <div class="form-group routing-mode-group" style="flex:1; min-width: 250px; margin:0;">
                                            <label style="margin-bottom:5px;">Routing Mode:</label>
                                            <select class="routing-mode-select" style="width: 100%;">
                                                <option value="ui">UI Defined (Publish single 'msg' to topics below)</option>
                                                <option value="code">Code Defined (Return array of {topic, payload})</option>
                                            </select>
                                        </div>
                                        <div class="form-group target-topic-group" style="flex:2; min-width: 300px; margin:0;">
                                            <label style="margin-bottom:5px;">Target Topic(s) (comma-separated)</label>
                                            <input type="text" class="target-output-topic" placeholder="e.g., my_uns/facility/{{id}}">
                                        </div>
                                    </div>
                                    <div class="target-workspace">
                                        <div class="target-code-group">
                                            <div class="target-code-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                                <label class="target-code-label" style="margin:0;">Transform (JavaScript)</label>
                                                <button type="button" class="target-maximize-code tool-button" style="font-size:0.8em; padding:4px 10px;">‚õ∂ Maximize</button>
                                            </div>
                                            <div class="target-code-editor" spellcheck="false"></div>
                                        </div>
                                        <div class="target-side-panel">
                                            <div class="maximized-payload-ref">
                                                <label style="margin:0 0 10px 0; font-weight:bold; border-bottom:1px solid var(--color-border); padding-bottom:5px;">Source Payload Reference</label>
                                                <pre class="maximized-payload-content"></pre>
                                            </div>
                                            <div class="target-metrics">
                                                <h5 class="target-metrics-title">Metrics</h5>
                                                <div class="target-metrics-counter">Count: <span class="metric-count">0</span></div>
                                                <div class="target-metrics-logs">
                                                    <h6 class="target-logs-title">Recent Executions:</h6>
                                                    <div class="target-logs-list">
                                                        <p class="history-placeholder">No executions yet.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </form>
                </div>
            </div>
        </main>

        <main id="chart-view" class="view">
            <div class="chart-tree-wrapper">
                <div class="tree-controls">
                    <input type="text" id="chart-filter-input" placeholder="Filter topics...">
                    <button id="btn-chart-expand-all" class="tool-button" title="Expand All">‚ñ≤</button>
                    <button id="btn-chart-collapse-all" class="tool-button" title="Collapse All">‚ñº</button>
                </div>
                <div id="chart-tree" class="tree-container">
                    </div>
            </div>
            <div class="resizer" id="drag-handle-vertical-chart"></div>
            <div id="chart-payload-container" class="payload-container">
                <div id="chart-payload-area">
                    <div class="payload-header">
                        <h2>Payload &amp; Variables</h2>
                    </div>
                    <div id="chart-payload-topic" class="payload-topic-display">Select a topic from the Chart tree.
                    </div>
                    <div id="chart-variable-list" class="chart-variable-list">
                        <p class="history-placeholder">No numeric properties found in this payload.</p>
                    </div>
                </div>
                <div class="resizer-horizontal" id="drag-handle-horizontal-chart"></div>
                <div id="chart-main-area">
                    <div class="chart-config-bar">
                        <div class="form-group">
                            <label for="chart-config-select">Saved Charts:</label>
                            <select id="chart-config-select">
                                <option value="">-- New Chart --</option>
                            </select>
                        </div>
                        <button id="btn-chart-save-current" class="tool-button button-primary" title="Save">Save</button>
                        <button id="btn-chart-save-as" class="tool-button" title="Save As New...">Save As...</button>
                        <button id="btn-chart-delete-config" class="tool-button button-danger" title="Delete Selected Chart">Delete</button>
                        
                        <div class="form-group">
                            <label for="chart-type-select">Type:</label>
                            <select id="chart-type-select">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                                <option value="pie">Pie</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="chart-connect-nulls-toggle" name="chart-connect-nulls-toggle">
                            <label for="chart-connect-nulls-toggle" class="checkbox-label">Connect Gaps</label>
                        </div>
                        <div class="form-group">
                            <input type="checkbox" id="chart-smart-axis-toggle" name="chart-smart-axis-toggle" checked>
                            <label for="chart-smart-axis-toggle" class="checkbox-label" title="Group variables with similar names on the same axis">Smart Axis</label>
                        </div>
                        <div class="form-group" style="display: flex; flex-direction: column; align-items: flex-start; gap: 0;">
                            <label style="font-size: 0.75em; margin-bottom: 2px;">Start</label>
                            <input type="datetime-local" id="chart-start-date" style="padding: 4px; font-size: 0.85em;">
                        </div>
                        <div class="form-group" style="display: flex; flex-direction: column; align-items: flex-start; gap: 0;">
                            <label style="font-size: 0.75em; margin-bottom: 2px;">End</label>
                            <input type="datetime-local" id="chart-end-date" style="padding: 4px; font-size: 0.85em;">
                        </div>
                        <div id="chart-range-buttons" style="display: flex; gap: 5px; flex-wrap: wrap;"></div>
                        <button id="btn-chart-clear" class="tool-button" style="color:var(--color-danger); border-color:var(--color-danger);" title="Clear All Selections">Clear All</button>
                        <button id="btn-chart-export-csv" class="tool-button" title="Export CSV">CSV</button>
                        <button id="btn-chart-export-png" class="tool-button" title="Export PNG">PNG</button>
                        <button id="btn-chart-fullscreen" class="tool-button" title="Toggle Fullscreen">&#x2922;</button>
                        <span id="chart-save-status"></span>
                    </div>
                    
                    <div id="chart-time-range-slider-container" class="time-slider-container">
                        <div class="slider-track"></div>
                        <div class="slider-range" id="chart-slider-range"></div>
                        <div class="slider-handle" id="chart-handle-min">
                            <div class="slider-label" id="chart-label-min"></div>
                        </div>
                        <div class="slider-handle" id="chart-handle-max">
                            <div class="slider-label" id="chart-label-max"></div>
                        </div>
                    </div>

                    <div id="chart-canvas-container">
                        <p id="chart-placeholder">Select a topic, choose variables, and click "Refresh", or load a saved chart.</p>
                        <canvas id="chart-canvas" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <main id="alerts-view" class="view">
            </main>

        <main id="publish-view" class="view">
            <div class="publish-panel-wrapper">
                <h2>Manual Publish</h2>
                <form id="publish-form">
                    <div class="form-group">
                        <label for="publish-topic">Topic</label>
                        <input type="text" id="publish-topic" placeholder="e.g., stark_industries/malibu_facility/bms/main_power_feed" required>
                    </div>
                    <div class="publish-options-row">
                        <div class="form-group">
                            <label for="publish-format">Payload Format</label>
                            <select id="publish-format">
                                <option value="json">JSON</option>
                                <option value="string">String</option>
                                <option value="sparkplugb">Sparkplug B (JSON input)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="publish-qos">QoS</label>
                            <select id="publish-qos">
                                <option value="0">0 - At most once</option>
                                <option value="1">1 - At least once</option>
                                <option value="2">2 - Exactly once</option>
                            </select>
                        </div>
                        <div class="form-group form-group-checkbox">
                            <input type="checkbox" id="publish-retain">
                            <label for="publish-retain" class="checkbox-label">Retain Message</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label >Payload</label>
                        <div id="publish-payload-editor" spellcheck="false"></div>
                    </div>
                    <div class="publish-actions">
                        <button type="submit" id="publish-button" class="tool-button button-primary" style="padding: 10px 20px; font-size: 1em;">Publish Message</button>
                        <span id="publish-status"></span>
                    </div>
                </form>
            </div>
            <div class="resizer" id="drag-handle-vertical-publish"></div>
            
            <div class="simulator-panel-wrapper">
                <h2>Simulator</h2>
                <div class="simulator-controls-container">
                    <p>Control the built-in data simulators.</p> 
                    <div id="simulator-list-container" class="simulator-controls">
                    </div>
                    <template id="simulator-control-template">
                        <div class="simulator-instance-controls">
                            <h3 class="simulator-name"></h3>
                            <span class="status-indicator stopped">Stopped</span>
                            <button class="tool-button btn-start-sim">Start</button>
                            <button class="tool-button btn-stop-sim" disabled>Stop</button>
                        </div>
                    </template>
                </div>
            </div>
        </main>
        
        <main id="admin-view" class="view" style="flex-direction: column; overflow: hidden; padding: 0;">
            </main>
    </div>

    <div id="chat-widget-container" class="chat-widget-container">
        <div class="chat-header">
            <span>AI Assistant</span>
            <div class="chat-controls">
                <button id="btn-chat-clear" title="Clear History">üóëÔ∏è</button>
                <button id="btn-chat-minimize" title="Minimize">_</button>
            </div>
        </div>
        <div class="chat-body">
            <div id="chat-history" class="chat-history-container">
            </div>
            <div class="chat-input-area">
                <textarea id="chat-input" rows="1" placeholder="Ask..."></textarea>
                <button id="btn-send-chat">‚û§</button>
            </div>
        </div>
    </div>
    
    <button id="btn-chat-fab" class="chat-fab" title="Open AI Assistant">
        üí¨
    </button>

    <div id="delete-rule-modal-backdrop" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h3 id="delete-modal-title">Confirm Deletion</h3>
            <p id="delete-modal-text">What would you like to do with the rule for the target topic:</p>
            <p id="delete-modal-topic" class="modal-topic-display"></p>
            <div class="form-group">
                <label for="delete-modal-pattern">Topic to prune (uses <code>+</code> and <code>#</code>)</label>
                <input type="text" id="delete-modal-pattern" class="modal-input">
            </div>
            <div class="modal-actions">
                <button id="modal-btn-cancel" class="tool-button">Cancel</button>
                <button id="modal-btn-delete-rule" class="tool-button button-primary">Delete Rule Only</button>
                <button id="modal-btn-delete-prune" class="tool-button button-danger">Delete Rule &amp; Prune
                    History</button>
            </div>
        </div>
    </div>

    <footer class="app-footer">
        <p>Clone me, enhance me, read documentation or request features on <a href="https://github.com/slalaure/mqtt_uns_viewer" target="_blank"
                rel="noopener noreferrer">github</a></p>
    </footer>

    <script src="view.login.js" type="module"></script>
    <script src="app.js" type="module"></script>
    <script src="view.chart.js" type="module"></script>
    <script src="view.publish.js" type="module"></script> 
    <script src="view.chat.js" type="module"></script>
    <script src="view.alerts.js" type="module"></script> 
    <script src="view.admin.js" type="module"></script>
</body>
</html>