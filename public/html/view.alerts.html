<div class="alerts-sub-nav">
    <button class="sub-tab-button active" data-target="active-alerts-panel">üö® Active Alerts</button>
    <button class="sub-tab-button" data-target="alert-rules-panel">‚öôÔ∏è Alert Rules</button>
</div>
<div id="active-alerts-panel" class="alerts-content-container active">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2>Live Dashboard</h2>
        <div style="display:flex; align-items:center; gap:15px;">
            <label style="font-size:0.9em; cursor:pointer; user-select:none; display:flex; align-items:center; gap:6px;">
                <input type="checkbox" id="chk-hide-resolved"> 
                <strong>Hide Resolved</strong>
            </label>
            <button id="btn-alerts-fullscreen" class="tool-button" title="Toggle Fullscreen" style="padding: 4px 10px;">&#x2922;</button>
            <span style="font-size:0.8em; color:var(--color-text-secondary); border-left:1px solid #ccc; padding-left:15px;">Updates automatically</span>
        </div>
    </div>
    
    <div class="alerts-controls" style="display: flex; gap: 10px; margin-bottom: 15px;">
        <select id="alerts-broker-filter" style="width: auto; padding: 6px 10px; border-radius: 4px; border: 1px solid var(--color-border); background-color: var(--color-bg); color: var(--color-text); display: none;">
            <option value="all">All Brokers</option>
        </select>
        <input type="text" id="alerts-search-input" placeholder="Search alerts by topic, rule name or payload..." style="flex-grow: 1; padding: 6px 10px; border-radius: 4px; border: 1px solid var(--color-border); background-color: var(--color-bg); color: var(--color-text);">
    </div>

    <div id="alerts-table-wrapper" style="overflow-x: auto;">
        <table class="alerts-table">
            <thead>
                <tr>
                    <th style="width: 130px;">Time</th> <th style="width: 90px;">Severity</th> <th style="width: 20%;">Rule / Topic</th>
                    <th style="width: 90px;">Status</th>
                    <th style="width: 15%;">Trigger Value</th> <th style="width: auto;">AI Analysis &amp; Actions</th> 
                </tr>
            </thead>
            <tbody id="active-alerts-body">
                <tr><td colspan="6" style="text-align:center;">Waiting for alerts...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="alert-rules-panel" class="alerts-content-container">
    <div id="rules-list-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2>Detection Rules</h2>
            <button id="btn-new-rule" class="tool-button button-primary">+ New Rule</button>
        </div>
        <table class="alerts-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Topic Pattern</th>
                    <th>Severity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="alert-rules-body">
                <tr><td colspan="4" style="text-align:center;">Loading...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div id="rule-editor-container" class="rule-editor-container" style="display:none;">
        <div class="rule-editor-header">
            <h3 id="rule-editor-title">Create / Edit Rule</h3>
            <button id="btn-cancel-rule" class="tool-button">Cancel</button>
        </div>
        <form id="rule-form">
            <div class="form-group">
                <label>Rule Name</label>
                <input type="text" name="name" required placeholder="e.g. High Temp Warning">
            </div>
            <div class="form-group">
                <label>Topic Pattern (Wildcards allowed)</label>
                <input type="text" name="topic_pattern" required placeholder="e.g. factory/+/temp">
            </div>
            <div class="form-group">
                <label>Severity</label>
                <select name="severity">
                    <option value="info">Info</option>
                    <option value="warning">Warning</option>
                    <option value="critical">Critical</option>
                </select>
            </div>
            <div class="form-group">
                <div class="label-with-icon">
                    <label style="margin:0;">Condition (JavaScript)</label>
                    <span id="btn-js-help" class="info-icon" title="See Examples">‚ÑπÔ∏è</span>
                </div>
                <span class="help-text">
                    Available vars: <code>msg.payload</code>, <code>msg.topic</code>. <br>
                    Must return <code>true</code> to trigger. Async <code>await db.get(...)</code> supported.
                </span>
                <div id="rule-condition-editor" class="code-editor-wrapper"></div>
            </div>
            <div class="form-group">
                <label>AI Analysis Prompt (Workflow)</label>
                <textarea name="workflow_prompt" rows="3" placeholder="e.g. Analyze this temperature spike. Check maintenance logs for this machine."></textarea>
            </div>
            <div class="form-group">
                <div class="label-with-icon">
                    <label style="margin:0;">Webhook URL (HTTP POST)</label>
                    <span class="info-icon" title="Trigger external systems">üîó</span>
                </div>
                <span class="help-text">Enter a URL to receive a POST request when alert triggers. <br>Example: <code>https://chat.googleapis.com/v1/spaces/AAAA/messages?key=...</code> (Google Chat) or Slack/Teams webhook.</span>
                <input type="text" name="webhook" placeholder="https://chat.googleapis.com/v1/spaces/AAAA/messages?key=...">
            </div>
            <div style="text-align:right;">
                <button type="submit" class="tool-button button-primary">Save Rule</button>
            </div>
        </form>
    </div>
</div>

<div id="alert-help-modal" class="modal-backdrop" style="display:none;">
    <div class="help-modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3 style="margin:0;">JavaScript Condition Examples</h3>
            <button id="btn-close-help" style="background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
        </div>
        <div class="example-block">
            <div class="example-title">1. Simple Threshold (JSON)</div>
            <div class="example-code">// Topic: stark_industries/malibu_facility/assembly_line_01/palladium_core_cell/robotic_arm_01/temperature
// Trigger if temp > 70
return msg.payload.value > 70;</div>
        </div>
        <div class="example-block">
            <div class="example-title">2. Sparkplug B (Complex Object)</div>
            <div class="example-code">// Topic: spBv1.0/stark_industries/DDATA/robot_arm_01
// Find specific metric in array
if (!msg.payload.metrics) return false;
const metric = msg.payload.metrics.find(m => m.name === "Motor/Temp");
// Trigger if temp > 80.0
return metric && metric.value > 80.0;</div>
        </div>
        <div class="example-block">
            <div class="example-title">3. Anomaly Detection (Compare vs History)</div>
            <div class="example-code">// Topic: stark_industries/malibu_facility/bms/main_power_feed
// Compare current value vs Average of last 10 values
const currentVal = msg.payload.value;

// SQL to get avg from history (DuckDB syntax)
const sql = `
    SELECT AVG(CAST(payload->>'value' AS DOUBLE)) as avg_val 
    FROM mqtt_events 
    WHERE topic = '${msg.topic}' 
    ORDER BY timestamp DESC LIMIT 10
`;

// Async database call
const result = await db.get(sql);

// Trigger if current value is 20% higher than average
if (result && result.avg_val) {
    return currentVal > (result.avg_val * 1.20);
}
return false;</div>
        </div>
        <div style="text-align:right;">
             <button id="btn-close-help-2" class="tool-button">Close</button>
        </div>
    </div>
</div>

<div id="analysis-modal" class="modal-backdrop" style="display:none; z-index: 3000;">
    <div class="help-modal-content" style="max-width: 800px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #ccc; padding-bottom:10px;">
            <h3 style="margin:0;">ü§ñ AI Analysis Report</h3>
            <button id="btn-close-analysis" style="background:none; border:none; font-size:1.5em; cursor:pointer;">&times;</button>
        </div>
        <div id="analysis-content" class="analysis-content" style="line-height:1.6;"></div>
        <div style="text-align:right; margin-top:20px;">
             <button id="btn-close-analysis-2" class="tool-button">Close</button>
        </div>
    </div>
</div>